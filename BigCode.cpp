This is big code - from dev1 conflict
